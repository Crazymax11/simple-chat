<!DOCTYPE html>
<html lang="en">
<script src="https://code.jquery.com/jquery-2.2.2.min.js"></script>
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">

<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<div>
    <div class="container-fluid row" style="height: 800px">
        <div class="col-md-9" id="messages"> messages</div>
        <div class="col-md-3" id="userlist"> users</div>
    </div>
    <div class="input-group">
        <input type="text" class="form-control" placeholder="Search for...">
      <span class="input-group-btn">
        <button class="btn btn-default" id="send" type="button">Go!</button>
      </span>
    </div>
    <button class="btn btn-default" id="clear" type="button">clear</button>
</div>
<script>
    class ChatClient{
        constructor(values){
            this.socket = new WebSocket(values.url);
            this.users = [];
            this.socket.onmessage = function(event){
                var data = JSON.parse(event.data);
                switch(data.type){
                    case "new user":
                        this.users.push(data.username);
                        this.userConnected({username: data.username});
                        break;
                    case "disconnect":
                        this.users.splice(this.users.indexOf(data.user),1);
                        this.userDisconnected({user: data.user, message: data.message});
                        break;
                    case "rename":
                        this.users.splice(this.users.indexOf(data.from),1);
                        this.users.push(data.to);
                        this.userRenamed({from: data.from, to: data.to});
                        break;
                    case "message":
                        this.userMessaged({from: data.from, text: data.text});
                        break;
                }
            }.bind(this);
        }
        userDisconnected(values){

        }
        userConnected(values){

        }
        userRenamed(values){

        }
        userMessaged(values){

        }
        sendMessage(text){
            this.socket.send(JSON.stringify({type: "message", text: text}));
        }
        rename(newname){
            this.socket.send(JSON.stringify({type: "command", text: "/rename " + newname}));
        }

    }
</script>
<script>
    $(document).ready(function() {
        window.client = new ChatClient({url:"ws://localhost:1992"});
        client.userConnected = function(values){
            $("#userlist").append('<p>' + values.username + '</p>');
        };
        client.userDisconnected = function(values){
            $("#userlist").empty();
            for(var user of client.users) client.userConnected({username: user});
        };
        client.userRenamed = function(values){
            $("#userlist").empty();
            for(var user of client.users) client.userConnected({username: user});
        };
        client.userMessaged = function(values){
            $("#messages").append('<p>' + values.from + ": " +values.text + "</p>");
        }
    });
    $('#send').on('click', function () {
        sendData($('.form-control').val());
        $('.form-control').val("");

    });
    $('#clear').on('click', function(){
       $('#messages').empty();
    });
    function sendData(text){
        if (text.substring(0, "/rename".length) == "/rename"){
            var newname = text.substring("/rename".length + 1);
            client.rename(newname);
        }
        else{
            client.sendMessage(text);
        }
    }
    $('.form-control').bind("enterKey",function(e){
        sendData(this.value);
        this.value = "";
    });
    $('.form-control').keyup(function(e){
        if(e.keyCode == 13)
        {
            $(this).trigger("enterKey");
        }
    });
</script>
</body>
</html>